<Window
    xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:conv="clr-namespace:ItemNotes.UI.Converters"
    xmlns:avRichTextBox="clr-namespace:AvRichTextBox;assembly=AvRichTextBox"
    x:Class="ItemNotes.UI.Views.NoteWindow"
    Title="{Binding Note.Title}"
    Width="900"
    Height="640"
    RequestedThemeVariant="Light"
    SystemDecorations="None"
    WindowStartupLocation="CenterOwner">

    <Window.Resources>
        <conv:NoteColorToBrushConverter x:Key="NoteColorToBrushConverter"/>
    </Window.Resources>

    <Border x:Name="RootBorder"
            Background="{Binding Note.Color, Converter={StaticResource NoteColorToBrushConverter}}"
            CornerRadius="16"
            Padding="0"
            BorderThickness="2"
            BorderBrush="#2A000000">

        <DockPanel>

            <!-- Title / Toolbar -->
            <Border x:Name="TitleBar"
                    DockPanel.Dock="Top"
                    Background="#19FFFFFF"
                    Padding="8,6"
                    PointerPressed="TitleBar_PointerPressed">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- Sol: Format bar -->
                    <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                        <Button Content="Yeni Sayfa" Command="{Binding AddPageCommand}"/>
                        <Separator Width="8"/>

                        <!-- Durum gösteren Toggle'lar -->
                        <ToggleButton IsChecked="{Binding SelectedPage.IsBold, Mode=TwoWay}"
                                      Content="B" FontWeight="Bold"
                                      ToolTip.Tip="Kalın (Ctrl/⌘+B)"
                                      Command="{Binding BoldCommand}"/>
                        <ToggleButton IsChecked="{Binding SelectedPage.IsItalic, Mode=TwoWay}"
                                      Content="I" FontStyle="Italic"
                                      ToolTip.Tip="İtalik (Ctrl/⌘+I)"
                                      Command="{Binding ItalicCommand}"/>
                        <ToggleButton IsChecked="{Binding SelectedPage.IsUnderline, Mode=TwoWay}"
                                      Content="U"
                                      ToolTip.Tip="Altı Çizili (Ctrl/⌘+U)"
                                      Command="{Binding UnderlineCommand}"/>
                        <ToggleButton IsChecked="{Binding SelectedPage.IsStrike, Mode=TwoWay}"
                                      Content="S̶"
                                      ToolTip.Tip="Üstü Çizili"
                                      Command="{Binding StrikethroughCommand}"/>

                        <Separator Width="8"/>

                        <Button Content="• Liste" Command="{Binding BulletListCommand}"/>
                        <Button Content="Resim…" Command="{Binding InsertImageCommand}"/>
                        <Button Content="Tablo" Command="{Binding InsertTableCommand}"/>
                        <Button Content="Bağlantı" Command="{Binding InsertLinkCommand}"/>

                        <Separator Width="8"/>
                        <Button Content="Kaydet" Click="OnSaveClick" ToolTip.Tip="Kaydet (Ctrl/⌘+S)"/>
                    </StackPanel>

                    <!-- Sağ: renk ve meta -->
                    <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center" Spacing="8">
                        <Menu>
                            <MenuItem Header="Renk">
                                <MenuItem Header="Sarı" Click="ChangeColorYellow"/>
                                <MenuItem Header="Yeşil" Click="ChangeColorGreen"/>
                                <MenuItem Header="Kırmızı" Click="ChangeColorRed"/>
                            </MenuItem>
                            <MenuItem Header="Kapat" Click="OnCloseClick"/>
                        </Menu>
                        <TextBlock Text="·" Margin="4,0"/>
                        <TextBlock Text="{Binding Note.CreatedBy}"/>
                        <TextBlock Text="·"/>
                        <TextBlock Text="{Binding Note.CreatedAt, StringFormat='{}{0:yyyy-MM-dd HH:mm}'}"/>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- İçerik -->
            <TabControl ItemsSource="{Binding Pages}"
                        SelectedItem="{Binding SelectedPage}"
                        Margin="10,10,10,12">
                <TabControl.ItemTemplate>
                    <DataTemplate>
                        <TextBlock Text="{Binding Header}" />
                    </DataTemplate>
                </TabControl.ItemTemplate>

                <TabControl.ContentTemplate>
                    <DataTemplate>
                        <Border Background="#FFFFFF" CornerRadius="12" Padding="12">
                            <avRichTextBox:RichTextBox
                                x:Name="Editor"
                                FlowDocument="{Binding Document}"
                                IsReadOnly="{Binding IsReadOnly}"
                                Background="Transparent"
                                Foreground="Black"
                                KeyDown="Editor_KeyDown"
                                KeyUp="Editor_KeyUp"
                                PointerReleased="Editor_PointerReleased"/>
                        </Border>
                    </DataTemplate>
                </TabControl.ContentTemplate>
            </TabControl>
        </DockPanel>
    </Border>

    <!-- Kısayollar: Avalonia => KeyBindings -->
    <Window.KeyBindings>
        <KeyBinding Gesture="Ctrl+B" Command="{Binding BoldCommand}"/>
        <KeyBinding Gesture="Ctrl+I" Command="{Binding ItalicCommand}"/>
        <KeyBinding Gesture="Ctrl+U" Command="{Binding UnderlineCommand}"/>
        <KeyBinding Gesture="Ctrl+S" Command="{Binding SaveCommand}"/>

        <KeyBinding Gesture="Cmd+B" Command="{Binding BoldCommand}"/>
        <KeyBinding Gesture="Cmd+I" Command="{Binding ItalicCommand}"/>
        <KeyBinding Gesture="Cmd+U" Command="{Binding UnderlineCommand}"/>
        <KeyBinding Gesture="Cmd+S" Command="{Binding SaveCommand}"/>
    </Window.KeyBindings>
</Window>
